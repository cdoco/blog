<!DOCTYPE html><html lang="zh-Hans"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Life is strange"><title>PHP7 升级的那些事儿 | C &amp; Fish</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">PHP7 升级的那些事儿</h1><a id="logo" href="/.">C &amp; Fish</a><p class="description">Life is strange</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> Start</i></a><a href="/archives/"><i class="fa fa-archive"> Archiv</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">PHP7 升级的那些事儿</h1><div class="post-meta">Aug 15, 2017<span> | </span><span class="category"><a href="/categories/php/">php</a></span></div><div class="post-content"><h2 id="新特性"><a href="#新特性" class="headerlink" title="新特性"></a>新特性</h2><ul>
<li>标量类型声明</li>
<li>返回值类型声明</li>
<li>太空船操作符</li>
<li>NULL 合并运算符</li>
<li>通过 define 定义常量数组</li>
<li>Unicode codepoint 转译语法</li>
<li>Session options</li>
</ul>
<h3 id="标量类型声明"><a href="#标量类型声明" class="headerlink" title="标量类型声明"></a>标量类型声明</h3><p>有两种模式: 强制 ( 默认 ) 和 严格模式。<br>字符串 (string), 整数 (int), 浮点数 (float), 以及布尔值 (bool), 类名，接口，数组。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">check</span><span class="params">(int $bool)</span></span>&#123;</div><div class="line"></div><div class="line">    var_dump($bool);</div><div class="line">&#125;</div><div class="line"></div><div class="line">check(<span class="number">1</span>);</div><div class="line">check(<span class="keyword">true</span>);</div></pre></td></tr></table></figure>
<a id="more"></a>
<h3 id="返回值类型声明"><a href="#返回值类型声明" class="headerlink" title="返回值类型声明"></a>返回值类型声明</h3><p>PHP 7 增加了对返回类型声明的支持。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">arraysSum</span><span class="params">(array ...$arrays)</span>: <span class="title">array</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> array_map(<span class="function"><span class="keyword">function</span><span class="params">(array $array)</span>: <span class="title">int</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> array_sum($array);</div><div class="line"></div><div class="line">    &#125;, $arrays);</div><div class="line">&#125;</div><div class="line"></div><div class="line">print_r(arraysSum([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>], [<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>], [<span class="number">7</span>,<span class="number">8</span>,<span class="number">9</span>]));</div><div class="line"></div><div class="line"><span class="keyword">Array</span>(</div><div class="line">    [<span class="number">0</span>] =&gt; <span class="number">6</span></div><div class="line">    [<span class="number">1</span>] =&gt; <span class="number">15</span></div><div class="line">    [<span class="number">2</span>] =&gt; <span class="number">24</span></div><div class="line">)</div></pre></td></tr></table></figure>
<h3 id="太空船操作符"><a href="#太空船操作符" class="headerlink" title="太空船操作符"></a>太空船操作符</h3><p>太空船操作符用于比较两个表达式。当 $a 大于、等于或小于 $b 时它分别返回 -1 、 0 或 1 。 比较的原则是沿用 PHP 的常规比较规则进行的。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="comment">// Integers</span></div><div class="line"><span class="keyword">echo</span> <span class="number">1</span> &lt;=&gt; <span class="number">1</span>; <span class="comment">// 0</span></div><div class="line"><span class="keyword">echo</span> <span class="number">1</span> &lt;=&gt; <span class="number">2</span>; <span class="comment">// -1</span></div><div class="line"><span class="keyword">echo</span> <span class="number">2</span> &lt;=&gt; <span class="number">1</span>; <span class="comment">// 1</span></div><div class="line"></div><div class="line"><span class="comment">// Floats</span></div><div class="line"><span class="keyword">echo</span> <span class="number">1.5</span> &lt;=&gt; <span class="number">1.5</span>; <span class="comment">// 0</span></div><div class="line"><span class="keyword">echo</span> <span class="number">1.5</span> &lt;=&gt; <span class="number">2.5</span>; <span class="comment">// -1</span></div><div class="line"><span class="keyword">echo</span> <span class="number">2.5</span> &lt;=&gt; <span class="number">1.5</span>; <span class="comment">// 1</span></div><div class="line"></div><div class="line"><span class="comment">// Strings</span></div><div class="line"><span class="keyword">echo</span> <span class="string">"a"</span> &lt;=&gt; <span class="string">"a"</span>; <span class="comment">// 0</span></div><div class="line"><span class="keyword">echo</span> <span class="string">"a"</span> &lt;=&gt; <span class="string">"b"</span>; <span class="comment">// -1</span></div><div class="line"><span class="keyword">echo</span> <span class="string">"b"</span> &lt;=&gt; <span class="string">"a"</span>; <span class="comment">// 1</span></div></pre></td></tr></table></figure>
<h3 id="NULL-合并运算符"><a href="#NULL-合并运算符" class="headerlink" title="NULL 合并运算符"></a>NULL 合并运算符</h3><p>项目中存在大量同时使用三元表达式和 isset() 的情况，新增了 null 合并运算符 (??) 这个语法糖。如果变量存在且值不为 NULL ， 它就会返回自身的值，否则返回它的第二个操作数。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">isset</span>($_GET[<span class="string">'id'</span>]) ? $_GET[id] : <span class="string">'err'</span>; <span class="comment">// PHP5</span></div><div class="line"></div><div class="line">$_GET[<span class="string">'id'</span>] ?? <span class="string">'err'</span>; <span class="comment">// PHP7</span></div></pre></td></tr></table></figure>
<h3 id="通过-define-定义常量数组"><a href="#通过-define-定义常量数组" class="headerlink" title="通过 define 定义常量数组"></a>通过 define 定义常量数组</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line">define(<span class="string">'ANIMALS'</span>, [<span class="string">'dog'</span>, <span class="string">'cat'</span>, <span class="string">'bird'</span>]);</div><div class="line"></div><div class="line"><span class="keyword">echo</span> ANIMALS[<span class="number">1</span>]; <span class="comment">// outputs "cat"</span></div></pre></td></tr></table></figure>
<h3 id="intdiv-两个数相除-取整"><a href="#intdiv-两个数相除-取整" class="headerlink" title="intdiv() 两个数相除 取整"></a>intdiv() 两个数相除 取整</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line">var_dump(intdiv(<span class="number">7</span>, <span class="number">2</span>));</div><div class="line"></div><div class="line">输出 int(<span class="number">3</span>)</div></pre></td></tr></table></figure>
<h2 id="Unicode-codepoint-转译语法"><a href="#Unicode-codepoint-转译语法" class="headerlink" title="Unicode codepoint 转译语法"></a>Unicode codepoint 转译语法</h2><p>这接受一个以 16 进制形式的 Unicode codepoint ，并打印出一个双引号或 heredoc 包围的 UTF-8 编码格式的字符串。 可以接受任何有效的 codepoint ，并且开头的 0 是可以省略的。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">echo</span> <span class="string">"\u&#123;638c&#125;\u&#123;9605&#125;"</span>;</div><div class="line"><span class="meta">?&gt;</span></div><div class="line"></div><div class="line">旧版输出：\u&#123;<span class="number">638</span>c&#125;\u&#123;<span class="number">9605</span>&#125;</div><div class="line"></div><div class="line">新版输入：掌阅</div></pre></td></tr></table></figure>
<h2 id="Session-options"><a href="#Session-options" class="headerlink" title="Session options"></a>Session options</h2><p>现在， session_start() 函数可以接收一个数组作为参数，可以覆盖 php.ini 中 session 的配置项。<br>比如，把 cache_limiter 设置为私有的，同时在阅读完 session 后立即关闭。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line">session_start([</div><div class="line">    <span class="string">'cookie_lifetime'</span> =&gt; <span class="number">86400</span>,</div><div class="line">    <span class="string">'read_and_close'</span>  =&gt; <span class="keyword">true</span>,</div><div class="line">]);</div></pre></td></tr></table></figure>
<h2 id="不兼容性"><a href="#不兼容性" class="headerlink" title="不兼容性"></a>不兼容性</h2><ul>
<li>foreach 不再改变内部数组指针</li>
<li>16进制字符串不再被认为是数字</li>
<li>被移除的函数</li>
<li>移除了 ASP 和 script PHP 标签</li>
<li>JSON 扩展已经被 JSOND 取代</li>
<li>INI 文件中 # 注释格式被移除</li>
</ul>
<h3 id="foreach-不再改变内部数组指针"><a href="#foreach-不再改变内部数组指针" class="headerlink" title="foreach 不再改变内部数组指针"></a>foreach 不再改变内部数组指针</h3><p>在 PHP7 之前，当数组通过 foreach 迭代时，数组指针会移动。现在开始，不再如此，见下面代码:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line">$array = [<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>];</div><div class="line"><span class="keyword">foreach</span> ($array <span class="keyword">as</span> &amp;$val) &#123;</div><div class="line">    var_dump(current($array));</div><div class="line">&#125;</div><div class="line"><span class="meta">?&gt;</span></div><div class="line"></div><div class="line">PHP5 输出:</div><div class="line"></div><div class="line">int(<span class="number">1</span>)</div><div class="line">int(<span class="number">2</span>)</div><div class="line">bool(<span class="keyword">false</span>)</div><div class="line"></div><div class="line">PHP7 输出：</div><div class="line"></div><div class="line">int(<span class="number">0</span>)</div><div class="line">int(<span class="number">0</span>)</div><div class="line">int(<span class="number">0</span>)</div></pre></td></tr></table></figure>
<h3 id="十六进制字符串不再被认为是数字"><a href="#十六进制字符串不再被认为是数字" class="headerlink" title="十六进制字符串不再被认为是数字"></a>十六进制字符串不再被认为是数字</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line">var_dump(<span class="string">"0x123"</span> == <span class="string">"291"</span>);</div><div class="line">var_dump(is_numeric(<span class="string">"0x123"</span>));</div><div class="line">var_dump(<span class="string">"0xe"</span> + <span class="string">"0x1"</span>);</div><div class="line">var_dump(substr(<span class="string">"foo"</span>, <span class="string">"0x1"</span>));</div><div class="line"><span class="meta">?&gt;</span></div><div class="line"></div><div class="line">PHP5 输出：</div><div class="line"></div><div class="line">bool(<span class="keyword">true</span>)</div><div class="line">bool(<span class="keyword">true</span>)</div><div class="line">int(<span class="number">15</span>)</div><div class="line">string(<span class="number">2</span>) <span class="string">"oo"</span></div><div class="line"></div><div class="line">PHP7 输出：</div><div class="line"></div><div class="line">bool(<span class="keyword">false</span>)</div><div class="line">bool(<span class="keyword">false</span>)</div><div class="line">int(<span class="number">0</span>)</div><div class="line">Notice: A non well formed numeric value encountered in /tmp/test.php on line <span class="number">5</span></div><div class="line">string(<span class="number">3</span>) <span class="string">"foo"</span></div></pre></td></tr></table></figure>
<h3 id="PHP7-中被移除的函数"><a href="#PHP7-中被移除的函数" class="headerlink" title="PHP7 中被移除的函数"></a>PHP7 中被移除的函数</h3><ul>
<li>已废弃的 mcrypt_generic_end() 函数已被移除，请使用 mcrypt_generic_deinit() 代替</li>
<li>mcrypt_*<ul>
<li>mcrypt_ecb</li>
<li>mcrypt_cbc</li>
<li>mcrypt_cfb</li>
<li>mcrypt_ofb</li>
</ul>
</li>
<li>dl() 在 PHP-FPM 不再可用，在 CLI 和 embed SAPIs 中仍可用。</li>
<li>在配置文件 php.ini 中， always_populate_raw_post_data 、 asp_tags 、 xsl.security_prefs 被移除了。</li>
</ul>
<h3 id="移除了-ASP-和-script-PHP-标签"><a href="#移除了-ASP-和-script-PHP-标签" class="headerlink" title="移除了 ASP 和 script PHP 标签"></a>移除了 ASP 和 script PHP 标签</h3><p>使用类似 ASP 的标签，以及 script 标签来区分 PHP 代码的方式被移除。 受到影响的标签有： </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">%</span> %&gt;</span> 、 <span class="tag">&lt;<span class="name">%=</span> %&gt;</span> 、 <span class="tag">&lt;<span class="name">script</span> <span class="attr">language</span>=<span class="string">"php"</span>&gt;</span><span class="undefined"> </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div></pre></td></tr></table></figure>
<h2 id="ZVAL-结构体优化"><a href="#ZVAL-结构体优化" class="headerlink" title="ZVAL 结构体优化"></a>ZVAL 结构体优化</h2><p>PHP5 的 zval 结构体。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">zval_struct</span> &#123;</span></div><div class="line">    <span class="keyword">union</span> &#123;</div><div class="line">        <span class="keyword">long</span> lval;</div><div class="line">        <span class="keyword">double</span> dval;</div><div class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span></div><div class="line">            <span class="keyword">char</span> *val;</div><div class="line">            <span class="keyword">int</span> len;</div><div class="line">        &#125; str;</div><div class="line">        HashTable *ht;</div><div class="line">        zend_object_value obj;</div><div class="line">        zend_ast *ast;</div><div class="line">    &#125; value;</div><div class="line">    zend_uint refcount__gc;</div><div class="line">    zend_uchar type;</div><div class="line">    zend_uchar is_ref__gc;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h3 id="存在问题"><a href="#存在问题" class="headerlink" title="存在问题"></a>存在问题</h3><ul>
<li>这个结构体的大小是(在64位系统)24个字节</li>
<li>没有预留任何的自定义字段</li>
</ul>
<p>5.3的时候新引入专门解决循环引用的GC, 它不得采用如下的比较hack的做法:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* The following macroses override macroses from zend_alloc.h */</span></div><div class="line"><span class="meta">#<span class="meta-keyword">undef</span>  ALLOC_ZVAL</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> ALLOC_ZVAL(z)                                   \</span></div><div class="line">    <span class="keyword">do</span> &#123;                                                \</div><div class="line">        (z) = (zval*)emalloc(<span class="keyword">sizeof</span>(zval_gc_info));     \</div><div class="line">        GC_ZVAL_INIT(z);                                \</div><div class="line">    &#125; <span class="keyword">while</span> (<span class="number">0</span>)</div></pre></td></tr></table></figure>
<p>它用zval_gc_info劫持了zval的分配:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">zval_gc_info</span> &#123;</span></div><div class="line">    zval z;</div><div class="line">    <span class="keyword">union</span> &#123;</div><div class="line">        gc_root_buffer       *buffered;</div><div class="line">        <span class="class"><span class="keyword">struct</span> _<span class="title">zval_gc_info</span> *<span class="title">next</span>;</span></div><div class="line">    &#125; u;</div><div class="line">&#125; zval_gc_info;</div></pre></td></tr></table></figure>
<p>实际上来说我们在PHP5时代申请一个zval其实真正的是分配了32个字节。</p>
<h3 id="PHP7-的-zval-结构体。"><a href="#PHP7-的-zval-结构体。" class="headerlink" title="PHP7 的 zval 结构体。"></a>PHP7 的 zval 结构体。</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">zval_struct</span> &#123;</span></div><div class="line">    <span class="keyword">union</span> &#123;</div><div class="line">        zend_long         lval;             <span class="comment">/* long value */</span></div><div class="line">        <span class="keyword">double</span>            dval;             <span class="comment">/* double value */</span></div><div class="line">        zend_refcounted  *counted;</div><div class="line">        zend_string      *str;</div><div class="line">        zend_array       *arr;</div><div class="line">        zend_object      *obj;</div><div class="line">        zend_resource    *res;</div><div class="line">        zend_reference   *ref;</div><div class="line">        zend_ast_ref     *ast;</div><div class="line">        zval             *zv;</div><div class="line">        <span class="keyword">void</span>             *ptr;</div><div class="line">        zend_class_entry *ce;</div><div class="line">        zend_function    *func;</div><div class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span></div><div class="line">            <span class="keyword">uint32_t</span> w1;</div><div class="line">            <span class="keyword">uint32_t</span> w2;</div><div class="line">        &#125; ww;</div><div class="line">    &#125; value;</div><div class="line">    <span class="keyword">union</span> &#123;</div><div class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span></div><div class="line">            ZEND_ENDIAN_LOHI_4(</div><div class="line">                zend_uchar    type,         <span class="comment">/* active type */</span></div><div class="line">                zend_uchar    type_flags,</div><div class="line">                zend_uchar    const_flags,</div><div class="line">                zend_uchar    reserved)     <span class="comment">/* call info for EX(This) */</span></div><div class="line">        &#125; v;</div><div class="line">        <span class="keyword">uint32_t</span> type_info;</div><div class="line">    &#125; u1;</div><div class="line">    <span class="keyword">union</span> &#123;</div><div class="line">        <span class="keyword">uint32_t</span>     var_flags;</div><div class="line">        <span class="keyword">uint32_t</span>     next;                 <span class="comment">/* hash collision chain */</span></div><div class="line">        <span class="keyword">uint32_t</span>     cache_slot;           <span class="comment">/* literal cache slot */</span></div><div class="line">        <span class="keyword">uint32_t</span>     lineno;               <span class="comment">/* line number (for ast nodes) */</span></div><div class="line">        <span class="keyword">uint32_t</span>     num_args;             <span class="comment">/* arguments number for EX(This) */</span></div><div class="line">        <span class="keyword">uint32_t</span>     fe_pos;               <span class="comment">/* foreach position */</span></div><div class="line">        <span class="keyword">uint32_t</span>     fe_iter_idx;          <span class="comment">/* foreach iterator index */</span></div><div class="line">    &#125; u2;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>这个新的zval在64位环境下,现在只需要16个字节(2个指针size)。</p>
<h3 id="PHP7-类型"><a href="#PHP7-类型" class="headerlink" title="PHP7 类型"></a>PHP7 类型</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* regular data types */</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_UNDEF                    0</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_NULL                     1</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_FALSE                    2</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_TRUE                     3</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_LONG                     4</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_DOUBLE                   5</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_STRING                   6</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_ARRAY                    7</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_OBJECT                   8</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_RESOURCE                 9</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_REFERENCE                10</span></div><div class="line"></div><div class="line"><span class="comment">/* constant expressions */</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_CONSTANT                 11</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_CONSTANT_AST             12</span></div><div class="line"></div><div class="line"><span class="comment">/* fake types */</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> _IS_BOOL                    13</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_CALLABLE                 14</span></div><div class="line"></div><div class="line"><span class="comment">/* internal types */</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_INDIRECT                 15</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_PTR                      17</span></div></pre></td></tr></table></figure>
<p>IS_BOOL -&gt; IS_FALSE, IS_TRUE</p>
<p>不再进行引用计数的类型：</p>
<p>IS_LONG<br>IS_DOUBLE</p>
<p>IS_NULL<br>IS_FALSE<br>IS_TRUE</p>
<h2 id="升级遇到的问题"><a href="#升级遇到的问题" class="headerlink" title="升级遇到的问题"></a>升级遇到的问题</h2><ul>
<li>memcahced 扩展问题<ul>
<li>libmemcahced 库版本依赖 &gt;= 1.0.18</li>
</ul>
</li>
<li>qconf 扩展问题</li>
<li>redis扩展</li>
<li>mcrypt 不兼容问题</li>
<li>使用 php7cc 检查整体代码的兼容性</li>
</ul>
<h3 id="qconf-扩展问题"><a href="#qconf-扩展问题" class="headerlink" title="qconf 扩展问题"></a>qconf 扩展问题</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">PHP_FUNCTION(test_bug)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">char</span> *path, *idc;</div><div class="line">    <span class="keyword">int</span> path_len, idc_len;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC,</div><div class="line">        <span class="string">"s|s"</span>, &amp;path, &amp;path_len, &amp;idc, &amp;idc_len) == FAILURE) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    RETVAL_STRINGL(path, path_len);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="redis-扩展问题"><a href="#redis-扩展问题" class="headerlink" title="redis 扩展问题"></a>redis 扩展问题</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">add_class_constants</span><span class="params">(...)</span> </span>&#123;</div><div class="line">    ............................</div><div class="line"></div><div class="line">    <span class="meta">#<span class="meta-keyword">ifdef</span> PHP_SESSION</span></div><div class="line">        php_session_register_module(&amp;ps_mod_redis);</div><div class="line">        php_session_register_module(&amp;ps_mod_redis_cluster);</div><div class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">&#125;</div><div class="line"></div><div class="line">PHP_MINIT_FUNCTION(redis)</div><div class="line">&#123;</div><div class="line">    ............................</div><div class="line">    ............................</div><div class="line"></div><div class="line">    <span class="comment">/* Add shared class constants to Redis and RedisCluster objects */</span></div><div class="line">    add_class_constants(redis_ce, <span class="number">0</span> TSRMLS_CC);</div><div class="line">    add_class_constants(redis_cluster_ce, <span class="number">1</span> TSRMLS_CC);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> SUCCESS;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="mcrypt"><a href="#mcrypt" class="headerlink" title="mcrypt"></a>mcrypt</h2><h3 id="PHP5"><a href="#PHP5" class="headerlink" title="PHP5"></a>PHP5</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">php_mcrypt_do_crypt</span><span class="params">(...)</span> <span class="comment">/* &#123;&#123;&#123; */</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    ..........................</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (count == <span class="number">0</span> &amp;&amp; key_length_sizes == <span class="literal">NULL</span>) &#123; <span class="comment">/* all lengths 1 - k_l_s = OK */</span></div><div class="line">        ..........................</div><div class="line"></div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (count == <span class="number">1</span>) &#123;  <span class="comment">/* only m_k_l = OK */</span></div><div class="line">        ..........................</div><div class="line"></div><div class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">/* dertermine smallest supported key &gt; length of requested key */</span></div><div class="line">        use_key_length = max_key_length; <span class="comment">/* start with max key length */</span></div><div class="line">        ..........................</div><div class="line"></div><div class="line">        key_s = emalloc(use_key_length);</div><div class="line">        <span class="built_in">memset</span>(key_s, <span class="number">0</span>, use_key_length);</div><div class="line">        <span class="built_in">memcpy</span>(key_s, key, MIN(key_len, use_key_length));</div><div class="line">    &#125;</div><div class="line">    ..........................</div></pre></td></tr></table></figure>
<h3 id="PHP7"><a href="#PHP7" class="headerlink" title="PHP7"></a>PHP7</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">php_mcrypt_do_crypt</span><span class="params">(...)</span> <span class="comment">/* &#123;&#123;&#123; */</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    ..........................</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (php_mcrypt_ensure_valid_key_size(td, (<span class="keyword">int</span>)key_len) == FAILURE &#123;</div><div class="line">        mcrypt_module_close(td);</div><div class="line">        RETURN_FALSE;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (php_mcrypt_ensure_valid_iv(td, iv, (<span class="keyword">int</span>)iv_len) == FAILURE) &#123;</div><div class="line">        mcrypt_module_close(td);</div><div class="line">        RETURN_FALSE;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ..........................</div></pre></td></tr></table></figure>
<p><a href="https://github.com/php/php-src/blob/PHP-5.4.32/ext/mcrypt/mcrypt.c" target="_blank" rel="external">php-src/ext/mcrypt/mcrypt.c</a></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line">var_dump(mcrypt_encrypt(MCRYPT_DES, <span class="string">"123456789"</span>, <span class="string">"123"</span>,</div><div class="line">MCRYPT_MODE_CBC, <span class="string">"12345678"</span>));</div></pre></td></tr></table></figure>
</div><div class="tags"><a href="/tags/php/">php</a></div><div class="post-nav"><a href="/2017/08/15/learn-regex-zh/" class="pre">学习正则表达式的简单方法</a><a href="/2016/03/10/php-ext-class/" class="next">PHP扩展实现类</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://cdoco.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Kategorien</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/C-语言/">C 语言</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/docker/">docker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/nginx/">nginx</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/php/">php</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/php扩展/">php扩展</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/regex/">regex</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/设计模式/">设计模式</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/linux/" style="font-size: 15px;">linux</a> <a href="/tags/gdb/" style="font-size: 15px;">gdb</a> <a href="/tags/php扩展/" style="font-size: 15px;">php扩展</a> <a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/c/" style="font-size: 15px;">c</a> <a href="/tags/regex/" style="font-size: 15px;">regex</a> <a href="/tags/ipc/" style="font-size: 15px;">ipc</a> <a href="/tags/php/" style="font-size: 15px;">php</a> <a href="/tags/lnmp/" style="font-size: 15px;">lnmp</a> <a href="/tags/mysql/" style="font-size: 15px;">mysql</a> <a href="/tags/nginx/" style="font-size: 15px;">nginx</a> <a href="/tags/shell/" style="font-size: 15px;">shell</a> <a href="/tags/设计模式/" style="font-size: 15px;">设计模式</a> <a href="/tags/xdebug/" style="font-size: 15px;">xdebug</a> <a href="/tags/phpstorm/" style="font-size: 15px;">phpstorm</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Letzte</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/11/07/learn-c/">C 语言基础入门</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/02/php-patterns/">PHP 设计模式</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/15/learn-regex-zh/">学习正则表达式的简单方法</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/15/php7-update/">PHP7 升级的那些事儿</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/10/php-ext-class/">PHP扩展实现类</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/23/debug-php-extension/">Debugging PHP Extensions</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/22/docker-basics/">docker常用命令</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/21/linux-ipc/">进程间通信（IPC）</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/21/nginx-cut-log/">nginx 直接在配置文件中切割日志</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/21/nginx-variables/">nginx 内置变量</a></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2017 <a href="/." rel="nofollow">C &amp; Fish.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>